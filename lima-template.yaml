# Lima VM template for Claude Code sandboxes
# Optimized for Apple Silicon with good defaults

# Use Ubuntu 24.04 for broad compatibility
images:
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img"
    arch: "aarch64"
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-amd64.img"
    arch: "x86_64"

# Resource allocation - adjust as needed
cpus: 4
memory: "8GiB"
disk: "{{DISK_SIZE}}"

# Mount the codebase ({{CODE_PATH}} is replaced at runtime)
mounts:
  - location: "{{CODE_PATH}}"
    mountPoint: "/workspace"
    writable: true
    9p:
      securityModel: mapped-xattr
      cache: mmap
  # Share Claude config from host (for auth)
  - location: "~/.claude"
    mountPoint: "/home/{{.User}}.linux/.claude"
    writable: true
    9p:
      securityModel: mapped-xattr
      cache: mmap

# SSH configuration
ssh:
  localPort: 0
  loadDotSSHPubKeys: true

# Provision the VM with essentials
provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      apt-get update
      apt-get install -y \
        build-essential \
        git \
        curl \
        wget \
        jq \
        unzip \
        ripgrep \
        fd-find \
        htop \
        vim \
        tmux \
        php \
        php-cli \
        php-curl \
        php-mbstring \
        php-xml \
        php-zip \
        php-mysql \
        composer
      apt-get clean
      rm -rf /var/lib/apt/lists/*

  #{{DOCKER_PROVISION_START}}
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      # Install Docker
      curl -fsSL https://get.docker.com | sh
      # Add the default Lima user to docker group
      usermod -aG docker $(getent passwd 1000 | cut -d: -f1)

  - mode: user
    script: |
      #!/bin/bash
      set -eux -o pipefail
      # Install Docker Compose plugin
      mkdir -p ~/.docker/cli-plugins
      ARCH=$(uname -m)
      if [ "$ARCH" = "aarch64" ]; then
        ARCH="aarch64"
      elif [ "$ARCH" = "x86_64" ]; then
        ARCH="x86_64"
      fi
      curl -SL "https://github.com/docker/compose/releases/latest/download/docker-compose-linux-${ARCH}" -o ~/.docker/cli-plugins/docker-compose
      chmod +x ~/.docker/cli-plugins/docker-compose
  #{{DOCKER_PROVISION_END}}

  - mode: user
    script: |
      #!/bin/bash
      set -eux -o pipefail
      # Create ~/.claude.json with onboarding flag to skip setup prompts
      echo '{"hasCompletedOnboarding": true}' > ~/.claude.json

      # Add to .profile for login shells
      cat >> ~/.profile << 'PROFILE'
      export PATH="$HOME/.local/bin:$PATH"
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
      if ! infocmp "$TERM" &>/dev/null 2>&1; then
        export TERM=xterm-256color
      fi
      # Set Claude OAuth token from shared credentials
      if [ -f "$HOME/.claude/.credentials.json" ]; then
        export CLAUDE_CODE_OAUTH_TOKEN=$(grep -o '"accessToken":"[^"]*"' "$HOME/.claude/.credentials.json" | cut -d'"' -f4)
      fi
      PROFILE

      # Add to .bashrc for interactive shells
      cat >> ~/.bashrc << 'BASHRC'
      # Claude Sandbox environment
      export PATH="$HOME/.local/bin:$PATH"
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
      if ! infocmp "$TERM" &>/dev/null 2>&1; then
        export TERM=xterm-256color
      fi
      # Set Claude OAuth token from shared credentials
      if [ -f "$HOME/.claude/.credentials.json" ]; then
        export CLAUDE_CODE_OAUTH_TOKEN=$(grep -o '"accessToken":"[^"]*"' "$HOME/.claude/.credentials.json" | cut -d'"' -f4)
      fi
      # Nice prompt showing we're in a sandbox
      PS1='\[\033[0;35m\][sandbox]\[\033[0m\] \[\033[0;34m\]\w\[\033[0m\] \$ '
      # Aliases
      alias ll='ls -la'
      alias claude='claude --dangerously-skip-permissions'
      BASHRC

# Enable containerd for running containers inside the VM if needed
containerd:
  system: false
  user: false

# Rosetta for x86 emulation on Apple Silicon (if needed)
rosetta:
  enabled: true
  binfmt: true

# Network configuration - use shared network for better reliability
vmType: "vz"
networks: []

# Message shown on start
message: |
  Claude Sandbox ready!

  Your codebase is mounted at /workspace
  Run 'claude' to start Claude Code in YOLO mode
  {{DOCKER_MESSAGE}}
  Tip: Use 'tmux' for persistent sessions
