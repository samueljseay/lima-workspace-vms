#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TEMPLATE_FILE="$SCRIPT_DIR/lima-template.yaml"
SANDBOX_PREFIX="sandbox-"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() { echo -e "${BLUE}▸${NC} $1"; }
log_success() { echo -e "${GREEN}✓${NC} $1"; }
log_warn() { echo -e "${YELLOW}!${NC} $1"; }
log_error() { echo -e "${RED}✗${NC} $1"; }

usage() {
    cat <<EOF
Claude Sandbox - Isolated development environments

Usage: sandbox <command> [options]

Commands:
    new <name> <path>     Create a new sandbox with codebase mounted
    attach <name>         Attach to an existing sandbox (starts if stopped)
    list                  List all sandboxes
    stop <name>           Stop a running sandbox
    delete <name>         Delete a sandbox
    status <name>         Show sandbox status

Examples:
    sandbox new myproject ~/Code/myproject
    sandbox attach woo
    sandbox list
    sandbox stop woo
    sandbox delete woo

The VM comes with Claude Code pre-installed and your codebase mounted at /workspace.
EOF
}

check_lima() {
    if ! command -v limactl &> /dev/null; then
        log_error "Lima is not installed. Install with: brew install lima"
        exit 1
    fi
}

get_vm_name() {
    echo "${SANDBOX_PREFIX}$1"
}

# Check if a VM exists by name
vm_exists() {
    local vm_name="$1"
    limactl list --json 2>/dev/null | jq -se ".[] | select(.name == \"$vm_name\")" &>/dev/null
}

# Get VM status by name
vm_status() {
    local vm_name="$1"
    limactl list --json 2>/dev/null | jq -rs ".[] | select(.name == \"$vm_name\") | .status"
}

cmd_new() {
    local name="${1:-}"
    local code_path="${2:-}"

    if [[ -z "$name" || -z "$code_path" ]]; then
        log_error "Usage: sandbox new <name> <path>"
        exit 1
    fi

    # Resolve to absolute path
    code_path="$(cd "$code_path" 2>/dev/null && pwd)" || {
        log_error "Path does not exist: $code_path"
        exit 1
    }

    local vm_name
    vm_name="$(get_vm_name "$name")"

    # Check if already exists
    if vm_exists "$vm_name"; then
        log_error "Sandbox '$name' already exists. Use 'sandbox attach $name' or delete it first."
        exit 1
    fi

    log_info "Creating sandbox '$name' with $code_path mounted..."

    # Generate config from template with the code path substituted
    local tmp_config
    tmp_config=$(mktemp)
    sed "s|{{CODE_PATH}}|$code_path|g" "$TEMPLATE_FILE" > "$tmp_config"

    # Create and start the VM
    limactl create --name="$vm_name" "$tmp_config"
    rm "$tmp_config"

    limactl start "$vm_name"

    log_success "Sandbox '$name' created and started!"
    log_info "Installing Claude Code (this may take a moment)..."

    # Install Claude Code and safety-net
    limactl shell "$vm_name" -- bash -c '
        # Install Node.js via nvm
        if ! command -v node &> /dev/null; then
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            nvm install --lts
        fi

        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

        # Install Claude Code
        if ! command -v claude &> /dev/null; then
            npm install -g @anthropic-ai/claude-code
            echo "✓ Claude Code installed"
        fi

        # Install Claude Code Safety Net
        if ! command -v claude-safety-net &> /dev/null; then
            npm install -g claude-code-safety-net
            claude-safety-net install
            echo "✓ Safety Net installed"
        fi
    '

    log_success "Setup complete! Run 'sandbox attach $name' to enter."
}

cmd_attach() {
    local name="${1:-}"

    if [[ -z "$name" ]]; then
        log_error "Usage: sandbox attach <name>"
        exit 1
    fi

    local vm_name
    vm_name="$(get_vm_name "$name")"

    # Check if exists
    if ! vm_exists "$vm_name"; then
        log_error "Sandbox '$name' does not exist. Create it with 'sandbox new $name <path>'"
        exit 1
    fi

    # Check status and start if needed
    local status
    status=$(vm_status "$vm_name")

    if [[ "$status" != "Running" ]]; then
        log_info "Starting sandbox '$name'..."
        limactl start "$vm_name"
    fi

    log_info "Attaching to sandbox '$name'..."
    log_info "Workspace mounted at /workspace"
    echo ""

    # Shell in with nvm loaded, starting in /workspace
    limactl shell --workdir /workspace "$vm_name"
}

cmd_list() {
    log_info "Sandboxes:"
    echo ""

    local found=false
    while IFS= read -r line; do
        local vm_name status
        vm_name=$(echo "$line" | jq -r '.name')
        status=$(echo "$line" | jq -r '.status')

        if [[ "$vm_name" == ${SANDBOX_PREFIX}* ]]; then
            found=true
            local display_name="${vm_name#$SANDBOX_PREFIX}"

            case "$status" in
                Running)
                    echo -e "  ${GREEN}●${NC} $display_name (running)"
                    ;;
                Stopped)
                    echo -e "  ${YELLOW}○${NC} $display_name (stopped)"
                    ;;
                *)
                    echo -e "  ${RED}○${NC} $display_name ($status)"
                    ;;
            esac
        fi
    done < <(limactl list --json 2>/dev/null | jq -sc '.[]')

    if [[ "$found" == false ]]; then
        echo "  No sandboxes found. Create one with 'sandbox new <name> <path>'"
    fi
    echo ""
}

cmd_stop() {
    local name="${1:-}"

    if [[ -z "$name" ]]; then
        log_error "Usage: sandbox stop <name>"
        exit 1
    fi

    local vm_name
    vm_name="$(get_vm_name "$name")"

    log_info "Stopping sandbox '$name'..."
    limactl stop "$vm_name"
    log_success "Sandbox '$name' stopped."
}

cmd_delete() {
    local name="${1:-}"

    if [[ -z "$name" ]]; then
        log_error "Usage: sandbox delete <name>"
        exit 1
    fi

    local vm_name
    vm_name="$(get_vm_name "$name")"

    log_warn "This will permanently delete sandbox '$name'."
    read -p "Are you sure? [y/N] " -n 1 -r
    echo

    if [[ $REPLY =~ ^[Yy]$ ]]; then
        limactl delete --force "$vm_name"
        log_success "Sandbox '$name' deleted."
    else
        log_info "Cancelled."
    fi
}

cmd_status() {
    local name="${1:-}"

    if [[ -z "$name" ]]; then
        log_error "Usage: sandbox status <name>"
        exit 1
    fi

    local vm_name
    vm_name="$(get_vm_name "$name")"

    limactl list --json 2>/dev/null | jq -s ".[] | select(.name == \"$vm_name\")"
}

# Main
check_lima

case "${1:-}" in
    new)
        cmd_new "${2:-}" "${3:-}"
        ;;
    attach|a)
        cmd_attach "${2:-}"
        ;;
    list|ls)
        cmd_list
        ;;
    stop)
        cmd_stop "${2:-}"
        ;;
    delete|rm)
        cmd_delete "${2:-}"
        ;;
    status)
        cmd_status "${2:-}"
        ;;
    -h|--help|help|"")
        usage
        ;;
    *)
        log_error "Unknown command: $1"
        usage
        exit 1
        ;;
esac
